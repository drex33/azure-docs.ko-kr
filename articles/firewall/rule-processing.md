---
title: Azure Firewall 규칙 처리 논리
description: Azure Firewall에는 NAT 규칙, 네트워크 규칙 및 애플리케이션 규칙이 있습니다. 규칙은 규칙 유형에 따라 처리됩니다.
services: firewall
author: vhorne
ms.service: firewall
ms.topic: article
ms.date: 11/09/2021
ms.author: victorh
ms.openlocfilehash: ec914df62c98ea7948c198949b34e37aa3c485d3
ms.sourcegitcommit: 838413a8fc8cd53581973472b7832d87c58e3d5f
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 11/10/2021
ms.locfileid: "132137348"
---
# <a name="configure-azure-firewall-rules"></a>Azure Firewall 규칙 구성
Azure Firewall에서 클래식 규칙 또는 방화벽 정책을 사용하여 NAT 규칙, 네트워크 규칙 및 애플리케이션 규칙을 구성할 수 있습니다. 트래픽을 허용하도록 규칙을 수동으로 구성할 때까지 Azure Firewall은 기본적으로 모든 트래픽을 거부합니다.

## <a name="rule-processing-using-classic-rules"></a>클래식 규칙을 사용하여 규칙 처리

규칙 컬렉션은 규칙 유형의 우선 순위에 따라 낮은 숫자(100)부터 높은 숫자(65,000) 순서로 처리됩니다. 규칙 컬렉션 이름에는 문자, 숫자, 밑줄, 마침표 또는 하이픈만 포함할 수 있습니다. 규칙 컬렉션 이름은 문자나 숫자로 시작하고 문자, 숫자 또는 밑줄로 끝나야 합니다. 최대 이름 길이는 80자입니다.

처음에 규칙 컬렉션 우선 순위 숫자를 100 단위로(예: 100, 200, 300) 설정하는 것이 가장 좋습니다. 이렇게 하면 필요할 때 규칙 컬렉션을 추가할 수 있는 여유가 있습니다.

## <a name="rule-processing-using-firewall-policy"></a>방화벽 정책을 사용하여 규칙 처리

방화벽 정책에서 규칙은 규칙 컬렉션 및 규칙 컬렉션 그룹 내에 구성됩니다. 규칙 컬렉션 그룹은 0개 이상의 규칙 컬렉션을 포함합니다. 규칙 컬렉션은 NAT, 네트워크 또는 애플리케이션 형식입니다. 단일 규칙 그룹 내에서 여러 가지 규칙 컬렉션 형식을 정의할 수 있습니다. 하나의 규칙 컬렉션에서 0개 이상의 규칙을 정의할 수 있습니다. 규칙 컬렉션의 규칙은 동일한 형식(NAT, 네트워크 또는 애플리케이션)이어야 합니다.    

규칙은 규칙 컬렉션 그룹 우선 순위 및 규칙 컬렉션 우선 순위에 따라 처리됩니다. 우선 순위는 100(가장 높은 우선 순위)에서 65,000(가장 낮은 우선 순위) 사이의 숫자입니다. 우선 순위가 가장 높은 규칙 컬렉션 그룹이 가장 먼저 처리됩니다. 규칙 컬렉션 그룹 내에서 우선 순위가 가장 높은(숫자가 가장 작은) 규칙 컬렉션이 가장 먼저 처리됩니다.  

방화벽 정책이 상위 정책에서 상속되는 경우 하위 정책의 우선 순위와 상관없이 상위 정책의 규칙 컬렉션 그룹이 항상 우선적으로 처리됩니다.  

> [!NOTE]
> 규칙 컬렉션 그룹 또는 규칙 컬렉션 우선 순위 및 정책 상속과 상관없이 애플리케이션 규칙은 항상 네트워크 규칙 후에 처리되며, 네트워크 규칙은 DNAT 규칙 후에 처리됩니다.

다음은 정책 예제입니다.


|Name  |유형  |우선 순위  |규칙  |다음에서 상속됨
|---------|---------|---------|---------|-------|
|BaseRCG1      |규칙 컬렉션 그룹           |200         |8         |상위 정책|
|DNATRc1     |DNAT 규칙 컬렉션         |  600       |   7      |상위 정책|
|NetworkRc1     |네트워크 규칙 컬렉션  | 800        |    1     |상위 정책|
|BaseRCG2  |규칙 컬렉션 그룹         |300         | 3        |상위 정책|
|AppRCG2     |애플리케이션 규칙 컬렉션 | 1200        |2         |상위 정책
|NetworkRC2     |네트워크 규칙 컬렉션         |1300         |    1     |상위 정책|
|ChildRCG1  | 규칙 컬렉션 그룹        | 300        |5         |-|
|ChAppRC1     |애플리케이션 규칙 컬렉션         |  700       | 3        |-|
|ChNetRC1       |   네트워크 규칙 컬렉션      |    900     |    2     |-|
|ChildRCG2      |규칙 컬렉션 그룹         | 650        |    9     |-|
|ChNetRC2      |네트워크 규칙 컬렉션         |    1100     |  2       |-|
|ChAppRC2      |     애플리케이션 규칙 컬렉션    |2000         |7         |-|
|ChDNATRC3     | DNAT 규칙 컬렉션        | 3000        |  2       |-|

규칙 처리 순서는 DNATRC1, DNATRC3, ChDNATRC3, NetworkRC1, NetworkRC2, ChNetRC1, ChNetRC2, AppRC2, ChAppRC1, ChAppRC2 순서입니다.

방화벽 정책 규칙 집합에 대한 자세한 내용은 [Azure Firewall 정책 규칙 집합을 참조하세요.](policy-rule-sets.md)

### <a name="threat-intelligence"></a>위협 인텔리전스

위협 인텔리전스 기반 필터링을 사용하는 경우 해당 규칙의 우선 순위가 가장 높고 항상 먼저(네트워크 및 애플리케이션 규칙보다 먼저) 처리됩니다. 위협 인텔리전스 필터링은 구성된 규칙이 처리되기 전에 트래픽을 거부할 수 있습니다. 자세한 내용은 [Azure Firewall 위협 인텔리전스 기반 필터링](threat-intel.md)을 참조하세요.

### <a name="idps"></a>IDPS

IDPS가 *경고* 모드에서 구성된 경우 IDPS 엔진은 규칙 처리 논리와 병렬로 작동하고 인바운드 및 아웃바운드 흐름의 서명 일치에 대한 경고를 생성합니다.IDPS 서명 일치의 경우 경고가 방화벽 로그에 기록됩니다. 그러나 IDPS 엔진이 규칙 처리 엔진과 병렬로 작동하므로 애플리케이션/네트워크 규칙에서 거부/허용된 트래픽은 여전히 다른 로그 항목을 생성할 수 있습니다. 

IDPS가 *경고 및 거부* 모드로 구성된 경우 IDPS 엔진은 인라인이며 규칙 처리 엔진 후에 활성화됩니다. 따라서 두 엔진 모두 경고를 생성하고 일치하는 흐름을 차단할 수 있습니다.  

IDPS에서 수행하는 세션 삭제는 흐름을 자동으로 차단합니다. 따라서 TCP 수준에서 RST가 전송되지 않습니다.IDPS는 네트워크/애플리케이션 규칙이 일치(허용/거부)하고 로그에 표시된 후 항상 트래픽을 검사하기 때문에, IDPS가 서명 일치 때문에 세션을 거부하도록 결정하는 다른 *삭제* 메시지가 기록될 수 있습니다. 

TLS 검사를 사용하면 암호화되지 않은 트래픽과 암호화된 트래픽이 모두 검사됩니다.  

## <a name="outbound-connectivity"></a>아웃바운드 연결

### <a name="network-rules-and-applications-rules"></a>네트워크 규칙 및 애플리케이션 규칙

네트워크 규칙과 애플리케이션 규칙을 구성하는 경우 애플리케이션 규칙 적용 전에 네트워크 규칙이 우선 순위에 따라 적용됩니다. 규칙은 종료됩니다. 따라서 네트워크 규칙에 일치하는 항목이 있으면 다른 규칙이 처리되지 않습니다. 구성할 경우 모든 트래버스된 트래픽과 서명 일치에 대해 IDPS가 수행되며, IDPS는 의심스러운 트래픽을 경고하거나 차단할 수 있습니다.  

네트워크 규칙이 일치하지 않고 프로토콜이 HTTP, HTTPS, MSSQL이면 우선 순위에 따라 패킷이 애플리케이션에 의해 평가됩니다.  

HTTP의 경우 Azure Firewall은 호스트 헤더에 따라 애플리케이션 규칙 일치 항목을 찾습니다. HTTPS의 경우 Azure Firewall은 오직 SNI에 따라 애플리케이션 규칙 일치 항목을 찾습니다.  

HTTP 및 TLS에서 검사한 HTTPS 사례 모두에서, 방화벽은 패킷 대상 IP 주소를 무시하고 호스트 헤더의 DNS 확인 IP 주소를 사용합니다. 방화벽은 호스트 헤더에서 포트 번호를 가져올 것으로 예상합니다. 그렇지 않은 경우 표준 포트 80을 가정합니다. 실제 TCP 포트와 호스트 헤더의 포트가 일치하지 않으면 트래픽이 드롭됩니다.DNS 확인은 Azure DNS 또는 방화벽에서 구성한 사용자 지정 DNS를 통해 수행됩니다.  

> [!NOTE]
> HTTP 및 HTTPS 프로토콜(TLS 검사 포함)은 항상 원래 원본 IP 주소와 동일한 XFF(X-Forwarded-For) 헤더를 사용하여 Azure Firewall로 채워집니다.  

애플리케이션 규칙에 TLS 검사가 포함되어 있으면 방화벽 규칙 엔진은 SNI, 호스트 헤더 그리고 규칙과 일치하도록 URL까지 처리합니다. 

여전히 애플리케이션 규칙 내에서 일치 항목을 찾을 수 없으면 인프라 규칙 컬렉션과 비교하여 패킷이 평가됩니다. 여전히 일치하는 항목이 없으면 패킷이 기본값으로 거부됩니다. 

> [!NOTE]
>  *TCP*, *UDP*, *ICMP* 또는  *Any* IP 프로토콜에 대한 네트워크 규칙을 구성할 수 있습니다. Any IP 프로토콜에는 IANA(Internet Assigned Numbers Authority) 프로토콜 번호 문서에 정의된 모든 IP 프로토콜이 포함됩니다. 대상 포트가 명시적으로 구성된 경우에는 규칙이 TCP+UDP 규칙으로 변환됩니다. 2020년 11월 9일 전에는  *는* 모든 이 TCP, UDP 또는 ICMP를 의미했습니다. 따라서 이 날짜 전에는 **Protocol = Any** 및 **destination ports = '*'** 를 사용하여 규칙을 구성했을 것입니다. IP 프로토콜을 현재 정의된 대로 허용할 생각이 아니라면 규칙을 수정하여 원하는 프로토콜(TCP, UDP 또는 ICMP)을 명시적으로 구성합니다. 

## <a name="inbound-connectivity"></a>인바운드 연결

### <a name="dnat-rules-and-network-rules"></a>DNAT 규칙 및 네트워크 규칙

[자습서: Azure Portal을 사용하여 Azure Firewall DNAT를 통해 인바운드 트래픽 필터링](tutorial-firewall-dnat.md)에 설명된 대로 DNAT(Destination Network Address Translation)를 구성하여 인바운드 인터넷 연결을 사용할 수 있습니다. NAT 규칙은 네트워크 규칙보다 우선 적용됩니다. 일치 항목이 발견되면 변환된 트래픽을 허용하도록 암시적인 해당 네트워크 규칙이 추가됩니다. 보안상의 이유로, 네트워크에 대한 DNAT 액세스를 허용하고 와일드카드를 사용하지 않도록 하기 위해 특정 인터넷 원본을 추가하는 것이 좋습니다.

인바운드 연결에는 애플리케이션 규칙이 적용되지 않습니다. 따라서 인바운드 HTTP/S 트래픽을 필터링하려면 WAF(Web Application Firewall)를 사용해야 합니다. 자세한 내용은 [Azure Web Application Firewall이란?](../web-application-firewall/overview.md)을 참조하세요.

## <a name="examples"></a>예제

다음 예제에서는 이러한 규칙 결합의 결과를 보여줍니다.

### <a name="example-1"></a>예제 1

일치하는 네트워크 규칙이 있으므로 google.com 연결이 허용됩니다.

**네트워크 규칙**

- 작업: 허용


|name  |프로토콜  |소스 형식  |원본  |대상 형식  |대상 주소  |대상 포트|
|---------|---------|---------|---------|----------|----------|--------|
|허용-웹     |TCP|IP 주소|*|IP 주소|*|80,443

**애플리케이션 규칙**

- 작업: Deny

|name  |소스 형식  |원본  |프로토콜:포트|대상 FQDN|
|---------|---------|---------|---------|----------|----------|
|Deny-google     |IP 주소|*|http:80, https:443|google.com

**결과**

패킷이 *Allow-web* 네트워크 규칙과 일치하므로 google.com 연결이 허용됩니다. 이 시점에서 규칙 처리가 중지됩니다.

### <a name="example-2"></a>예제 2

우선 순위가 더 높은 *Deny* 네트워크 규칙 컬렉션이 트래픽을 차단하므로 SSH 트래픽이 거부됩니다.

**네트워크 규칙 컬렉션 1**

- 이름: 허용-컬렉션
- 우선 순위: 200
- 작업: 허용

|name  |프로토콜  |소스 형식  |원본  |대상 형식  |대상 주소  |대상 포트|
|---------|---------|---------|---------|----------|----------|--------|
|허용-SSH     |TCP|IP 주소|*|IP 주소|*|22

**네트워크 규칙 컬렉션 2**

- 이름: 거부-컬렉션
- 우선 순위: 100
- 작업: Deny

|name  |프로토콜  |소스 형식  |원본  |대상 형식  |대상 주소  |대상 포트|
|---------|---------|---------|---------|----------|----------|--------|
|거부-SSH     |TCP|IP 주소|*|IP 주소|*|22

**결과**

우선 순위가 더 높은 네트워크 규칙 컬렉션이 연결을 차단하므로 SSH 연결이 거부됩니다. 이 시점에서 규칙 처리가 중지됩니다.

## <a name="rule-changes"></a>규칙 변경

이전에 허용된 트래픽을 거부하도록 규칙을 변경하면 관련된 모든 기존 세션이 삭제됩니다.

## <a name="3-way-handshake-behavior"></a>3 방향 핸드셰이크 동작

상태 저장 서비스의 경우 Azure 방화벽은 원본에서 대상으로 허용 된 트래픽에 대해 TCP 3 방향 핸드셰이크를 완료 합니다.예를 들어 vnet-A에서 VNet-B로.

Vnet-A에서 VNet-B로 허용 규칙을 만들면 VNet-B에서 VNet-A로 새로 시작 된 연결이 허용 됩니다.

따라서 VNet-B에서 VNet-A로의 명시적 거부 규칙을 만들 필요가 없습니다. 이 거부 규칙을 만드는 경우 VNet-A에서 VNet-B로의 초기 허용 규칙에서 3 방향 핸드셰이크를 중단 합니다. 

## <a name="next-steps"></a>다음 단계

- [Azure Azure Firewall을 배포 및 구성](tutorial-firewall-deploy-portal.md)하는 방법에 대해 알아봅니다.
