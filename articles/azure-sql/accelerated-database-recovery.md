---
title: 가속 데이터베이스 복구
titleSuffix: Azure SQL
description: 가속 데이터베이스 복구는 Azure SQL 포트폴리오의 데이터베이스에 대해 빠르고 일관된 데이터베이스 복구, 즉시 트랜잭션 롤백 및 적극적 로그 잘림을 제공합니다.
ms.service: sql-database
ms.subservice: backup-restore
ms.custom: sqldbrb=4
ms.devlang: ''
ms.topic: conceptual
author: kfarlee
ms.author: kfarlee
ms.reviewer: mathoma
ms.date: 05/19/2020
ms.openlocfilehash: aefc5be21dc60327baecbcc7614e9bc1a78f2ca1
ms.sourcegitcommit: 20acb9ad4700559ca0d98c7c622770a0499dd7ba
ms.translationtype: HT
ms.contentlocale: ko-KR
ms.lasthandoff: 05/29/2021
ms.locfileid: "110708979"
---
# <a name="accelerated-database-recovery-in-azure-sql"></a>Azure SQL의 가속 데이터베이스 복구 
[!INCLUDE[appliesto-sqldb-sqlmi](includes/appliesto-sqldb-sqlmi.md)]

**ADR(가속 데이터베이스 복구)** 은 SQL Server 데이터베이스 엔진 복구 프로세스를 다시 설계하여 특히 장기 실행 트랜잭션이 있는 경우 데이터베이스 가용성을 크게 향상시키는 SQL Server 데이터베이스 엔진 기능입니다. 

ADR은 현재 Azure SQL Database, Azure SQL Managed Instance, Azure Synapse Analytics의 데이터베이스 및 SQL Server 2019부터 Azure VM의 SQL Server에 사용할 수 있습니다. 

> [!NOTE] 
> ADR은 기본적으로 Azure SQL Database 및 Azure SQL Managed Instance에서 사용하도록 설정되며, 두 제품 중 하나에 대해 ADR을 비활성화는 것은 지원되지 않습니다. 

## <a name="overview"></a>개요

ADR의 주요 이점은 다음과 같습니다.

- **빠르고 일관된 데이터베이스 복구**

  ADR을 사용하면 장기 실행 트랜잭션이 전체 복구 시간에 영향을 주지 않으므로 시스템의 활성 트랜잭션 수 또는 크기에 관계없이 빠르고 일관된 데이터베이스 복구를 사용할 수 있습니다.

- **즉시 트랜잭션 롤백**

  ADR을 사용하면 트랜잭션이 활성 상태인 시간 또는 수행된 업데이트 수와 관계없이 트랜잭션 롤백이 즉시 수행됩니다.

- **적극적인 로그 잘림**

  ADR을 사용하면 활성 장기 실행 트랜잭션이 있는 경우에도 트랜잭션 로그가 적극적으로 잘리고 제어를 사용할 수 없게 됩니다.

## <a name="standard-database-recovery-process"></a>표준 데이터베이스 복구 프로세스

데이터베이스 복구는 [ARIES](https://people.eecs.berkeley.edu/~brewer/cs262/Aries.pdf) 복구 모델을 따르며 세 단계로 구성됩니다. 다음 다이어그램에 그림이 나와 있으며 그 뒤에 자세한 설명이 이어집니다.

![현재 복구 프로세스](./media/accelerated-database-recovery/current-recovery-process.png)

- **분석 단계**

  마지막으로 성공한 검사점(또는 가장 오래된 더티 페이지 LSN)의 시작부터 끝까지 트랜잭션 로그를 정방향 검사하여 데이터베이스가 중지될 때 각 트랜잭션의 상태를 확인합니다.

- **다시 실행 단계**

  가장 오래된 커밋되지 않은 트랜잭션부터 끝까지 트랜잭션 로그를 정방향 검사하고 모든 커밋된 작업을 다시 실행하여 크래시 당시의 상태로 데이터베이스를 되돌립니다.

- **실행 취소 단계**

  크래시 당시 활성 상태였던 각 트랜잭션에 대해 로그를 역방향으로 트래버스하고, 이 트랜잭션이 수행한 작업을 실행 취소합니다.

이 디자인에 따라, SQL Server 데이터베이스 엔진이 예기치 않은 다시 시작에서 복구하는 데 걸리는 시간은 크래시 당시 시스템에서 가장 오래된 활성 트랜잭션의 크기에 거의 비례합니다. 복구하려면 불완전한 모든 트랜잭션을 롤백해야 합니다. 필요한 시간은 트랜잭션이 수행한 작업과 활성 상태였던 시간에 비례합니다. 따라서 장기 실행 트랜잭션이 있을 때는 복구 프로세스가 오래 걸릴 수 있습니다(예: 큰 테이블에 대한 대량 삽입 작업 또는 인덱스 작성 작업).

또한 이 디자인을 기반으로 대형 트랜잭션을 취소/롤백하는 경우 위에서 설명한 것과 동일한 복구 실행 취소 단계를 사용하므로 시간이 오래 걸릴 수 있습니다.

뿐만 아니라 장기 실행 트랜잭션이 있으면 SQL Server 데이터베이스 엔진이 트랜잭션 로그를 자를 수 없습니다. 복구 및 롤백 프로세스에 해당 로그 레코드가 필요하기 때문입니다. 이 SQL Server 데이터베이스 엔진 디자인의 결과로, 일부 고객은 트랜잭션 로그의 크기가 매우 커지고 엄청난 양의 드라이브 공간이 사용되는 문제에 직면하곤 했습니다.

## <a name="the-accelerated-database-recovery-process"></a>가속 데이터베이스 복구 프로세스

ADR은 다음과 같이 SQL Server 데이터베이스 엔진 복구 프로세스를 완전히 다시 디자인하여 위의 문제를 해결합니다.

- 가장 오래된 활성 트랜잭션의 시작 부분에서 로그를 검색할 필요가 없도록 하여 시간/인스턴트를 일정하게 만듭니다. ADR을 사용하는 경우 트랜잭션 로그는 마지막으로 성공한 검사점(또는 가장 오래된 더티 페이지 LSN(로그 시퀀스 번호))에서만 처리됩니다. 따라서 복구 시간은 장기 실행 트랜잭션의 영향을 받지 않습니다.
- 전체 트랜잭션에 대한 로그를 더 이상 처리할 필요가 없기 때문에 필요한 트랜잭션 로그 공간을 최소화합니다. 결과적으로 트랜잭션 로그는 검사점 및 백업이 발생될 때 적극적으로 잘릴 수 있습니다.

상위 수준에서 ADR은 모든 물리적 데이터베이스 수정의 버전을 관리하고 제한적이면서 거의 즉시 실행 취소할 수 있는 논리 연산만 실행 취소하여 빠른 데이터베이스 복구를 달성합니다. 크래시 당시 활성 상태였던 트랜잭션은 중단된 것으로 표시되며, 따라서 이러한 트랜잭션을 통해 생성된 버전을 동시 사용자 쿼리에서 무시할 수 있습니다.

ADR 복구 프로세스는 현재 복구 프로세스와 동일한 3단계로 이루어져 있습니다. 이러한 단계가 ADR에서 작동하는 원리는 다음 다이어그램에 표시되어 있으며, 그 뒤에 자세한 설명이 이어집니다.

![ADR 복구 프로세스](./media/accelerated-database-recovery/adr-recovery-process.png)

- **분석 단계**

  이 프로세스는 이전과 동일하며, 버전이 없는 작업의 경우 sLog를 다시 작성하고 로그 레코드를 복사하는 단계가 추가되었습니다.
  
- **다시 실행** 단계

  두 단계(P)로 나뉩니다.
  - 1단계

      sLog(마지막 검사점까지 가장 오래된 커밋되지 않은 트랜잭션)에서 다시 실행합니다. 다시 실행은 sLog에서 몇 개의 레코드만 처리하면 되므로 빠른 작업입니다.

  - 2단계

     트랜잭션 로그에서 다시 실행은 마지막 검사점(커밋되지 않은 가장 오래된 트랜잭션 대신)에서 시작됩니다.

- **실행 취소 단계**

   ADR을 사용한 실행 취소 단계는 sLog를 사용하여 논리적 되돌리기로 버전이 지정되지 않은 작업 및 PVS(지속형 버전 저장소)를 실행 취소함으로써 행 수준 버전 기반 실행 취소를 수행하여 거의 즉시 완료됩니다.

## <a name="adr-recovery-components"></a>ADR 복구 구성 요소

ADR의 네 가지 주요 구성 요소는 다음과 같습니다.

- **PVS(지속형 버전 저장소)**

  지속형 버전 저장소는 기존의 `tempdb` 버전 저장소 대신 데이터베이스 자체에서 생성된 행 버전을 유지하는 새로운 SQL Server 데이터베이스 엔진 메커니즘입니다. PVS는 리소스 격리를 지원할 뿐 아니라 읽기 가능 보조 복제본의 가용성을 향상합니다.

- **논리적 되돌리기**

  논리적 되돌리기는 모든 버전의 작업에 대해 즉시 트랜잭션 롤백 및 실행 취소를 제공하는 행 수준 버전 기반 실행 취소를 수행하는 비동기 프로세스입니다. 논리적 되돌리기는 다음 작업으로 수행됩니다.

  - 중단된 모든 트랜잭션을 추적하고 다른 트랜잭션에 보이지 않는 상태로 표시합니다. 
  - 모든 사용자 트랜잭션에 PVS를 사용하여 롤백을 수행합니다. 트랜잭션 로그를 실제로 검사하고 변경 내용을 한 번에 하나씩 취소하지 않습니다.
  - 트랜잭션이 중단된 직후 모든 잠금을 해제합니다. 단순히 메모리의 변경 내용만 표시하는 중단 프로세스가 매우 효율적이므로 잠금을 오랫동안 유지하지 않아도 됩니다.

- **sLog**

  sLog는 버전이 없는 작업(예: 메타데이터 캐시 무효화, 잠금 획득 등)에 대한 로그 레코드를 저장하는 보조 메모리 내 로그 스트림입니다. sLog는 다음과 같습니다.

  - 적은 볼륨 및 메모리 내
  - 검사점 프로세스 중에 직렬화되어 디스크에 유지됩니다.
  - 트랜잭션이 커밋될 때 정기적으로 잘립니다.
  - 버전이 없는 작업만 처리하여 다시 실행 및 실행 취소를 가속화합니다.  
  - 필요한 로그 레코드만 유지하여 적극적인 트랜잭션 로그 잘림을 가능하게 합니다.

- **클리너**

  클리너는 정기적으로 절전 모드를 해제하고 필요하지 않은 페이지 버전을 정리하는 비동기 프로세스입니다.

## <a name="accelerated-database-recovery-patterns"></a>가속 데이터베이스 복구 패턴

다음 유형의 워크로드에는 ADR의 가장 큰 장점이 있습니다.

- 장기 실행 트랜잭션이 있는 워크로드
- 활성 트랜잭션이 트랜잭션 로그를 크게 증가시키는 경우가 있는 워크로드  
- 장기 실행 복구(예: 예기치 않은 서비스 다시 시작 또는 수동 트랜잭션 롤백)로 인해 장기간 데이터베이스를 사용하지 못한 경험이 있는 워크로드.
