---
title: Azure 웹 PubSub 서비스의 복원 력 및 재해 복구
description: 복원 력 및 재해 복구를 위해 여러 Azure 웹 PubSub 서비스 인스턴스를 설정 하는 방법에 대 한 개요입니다.
author: vicancy
ms.service: azure-web-pubsub
ms.topic: conceptual
ms.date: 11/08/2021
ms.author: lianwei
ms.openlocfilehash: 368c354f36cd6a289daacf1766c73021c1f08a3f
ms.sourcegitcommit: 27ddccfa351f574431fb4775e5cd486eb21080e0
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 11/08/2021
ms.locfileid: "131997971"
---
# <a name="resiliency-and-disaster-recovery-in-azure-web-pubsub-service"></a>Azure 웹 PubSub 서비스의 복원 력 및 재해 복구

복원력 및 재해 복구는 온라인 시스템에 공통적으로 필요합니다. Azure 웹 PubSub 서비스는 이미 99.9%의 가용성을 보장 하지만 여전히 지역 서비스입니다.

서비스 인스턴스가 지역 서비스 이며 인스턴스가 한 지역에서 실행 되 고 있습니다. 지역 전체 작동이 중단 되는 경우 서비스에서 다른 지역에 있는 실시간 메시지를 계속 처리 하는 것이 중요 합니다. 이 문서에서는 재해 복구를 허용 하도록 서비스를 배포 하는 데 사용할 수 있는 몇 가지 전략을 설명 합니다.

## <a name="high-available-architecture-for-web-pubsub-service"></a>웹 PubSub 서비스에 사용할 수 있는 고가용성 아키텍처

웹 PubSub 서비스에 대 한 지역 간 복원 력을 위해 여러 지역에서 여러 서비스 인스턴스를 설정 해야 합니다. 그러면 하나의 지역이 다운되는 경우 다른 지역을 백업으로 사용할 수 있습니다.

지역 간 시나리오에 대 한 일반적인 설정 중 하나는 둘 이상의 쌍의 웹 PubSub 서비스 인스턴스와 앱 서버를 포함 하는 것입니다.

각 쌍 앱 서버와 웹 PubSub 서비스는 동일한 지역에 있으며 웹 PubSub 서비스는 이벤트 처리기 업스트림을 동일한 지역의 앱 서버로 설정 합니다.

아키텍처를 보다 잘 설명 하기 위해 동일한 쌍의 앱 서버에 대해 웹 PubSub 서비스를 **기본** 서비스로 호출 합니다. 그리고 다른 쌍의 웹 PubSub 서비스를 앱 서버에 대 한 **보조** 서비스로 호출 합니다.

응용 프로그램 서버는 [service health CHECK API](/rest/api/webpubsub/health-api/get-service-status) 를 사용 하 여 **기본** 및 **보조** 서비스가 정상 인지 여부를 검색할 수 있습니다. 예를 들어 이라는 웹 PubSub 서비스의 경우 `demo` , `https://demo.webpubsub.azure.com/api/health` 서비스가 정상 상태 이면 끝점은 200을 반환 합니다. 앱 서버는 끝점을 주기적으로 호출 하거나 요청 시 끝점을 호출 하 여 끝점이 정상 인지 확인할 수 있습니다. WebSocket 클라이언트는 일반적으로 웹 PubSub 서비스에 연결 하는 URL을 가져오기 위해 먼저 응용 프로그램 서버와 **협상** 하 고, 응용 프로그램은이 **negotiate** 단계를 사용 하 여 클라이언트를 다른 정상적인 **보조** 서비스로 장애 조치 (failover) 합니다. 자세한 단계는 다음과 같습니다.

1. 클라이언트가 앱 서버와 **협상할** 때 앱 서버는 기본 웹 pubsub 서비스 끝점만 반환 해야 합니다. 따라서 일반적인 경우에만 클라이언트가 기본 끝점에 연결 합니다.
1. 주 인스턴스가 다운 되 면 **negotiate** 는 정상 상태의 보조 끝점을 반환 하 여 클라이언트에서 계속 연결을 설정 하 고 클라이언트에서 보조 끝점에 연결 합니다.
1. 기본 인스턴스를 사용할 때 **negotiate** 는 정상적인 기본 끝점을 반환 하 여 클라이언트가 기본 끝점에 연결할 수 있도록 해야 합니다.
1. 앱 서버는 메시지를 **브로드캐스트할** 때 **주** 및 **보조** 를 포함 하 여 모든 **정상** 끝점에 메시지를 **브로드캐스트합니다** .
1. 앱 서버는 **보조** 끝점에 연결 된 연결을 닫아 클라이언트를 정상적인 기본 끝점에 강제로 다시 연결할 수 있습니다.

이 토폴로지에서는 모든 앱 서버와 웹 PubSub 서비스 인스턴스가 상호 연결 되어 있기 때문에 한 서버의 메시지도 모든 클라이언트에 배달 될 수 있습니다.

전략을 SDK에 아직 통합 하지 않았으므로 지금은 응용 프로그램에서이 전략을 구현 해야 합니다. 

요약 하자면 응용 프로그램 쪽에서 구현 해야 하는 항목은 다음과 같습니다.
1. 상태 검사. 응용 프로그램은 서비스 [상태 검사 API](/rest/api/webpubsub/health-api/get-service-status) 를 사용 하 여 백그라운드에서 정기적으로 또는 모든 **negotiate** 호출에 대 한 요청에 따라 서비스가 정상 상태 인지 확인할 수 있습니다.
1. 논리 협상. 응용 프로그램은 기본적으로 정상적인 **기본** 끝점을 반환 합니다. **기본** 끝점이 중단 되 면 응용 프로그램은 정상 상태의 **보조** 끝점을 반환 합니다.
1. 브로드캐스트 논리. 여러 클라이언트에 메시지를 보낼 때 응용 프로그램은 메시지를 모든 **정상** 끝점으로 브로드캐스팅하는 지 확인 해야 합니다.

다음은 이러한 토폴로지를 보여주는 다이어그램입니다.

![다이어그램에는 각각 앱 서버와 웹 PubSub 서비스를 사용 하는 두 개의 지역이 표시 됩니다. 여기서 각 서버는 해당 지역의 웹 PubSub 서비스와 기본으로 연결 되 고 다른 지역의 서비스는 보조로 연결 됩니다.](media/concept-disaster-recovery/topology.png)

## <a name="failover-sequence-and-best-practice"></a>장애 조치(Failover) 시퀀스와 모범 사례

이제 올바른 시스템 토폴로지 설정이 완료되었습니다. 하나의 웹 PubSub 서비스 인스턴스가 다운 될 때마다 온라인 트래픽이 다른 인스턴스로 라우팅됩니다.
기본 인스턴스가 다운되는 경우 다음과 같은 상황이 발생합니다(그리고 얼마 후 복구됨).

1. 주 서비스 인스턴스가 종료 되 면이 인스턴스에 연결 된 모든 클라이언트가 삭제 됩니다.
2. 새 클라이언트 또는 앱 서버와의 클라이언트 **협상** 다시 연결
2. 앱 서버에서 기본 서비스 인스턴스가 중단 되었음을 감지 하 고 negotiate는이 끝점의 반환을 중지 하 고 정상 상태의 보조 끝점을 반환 하기 시작 합니다.
3. 클라이언트는 보조 인스턴스에 연결 됩니다.
4. 이제 보조 인스턴스가 모든 온라인 트래픽을 사용하게 됩니다. 보조가 모든 앱 서버에 연결되므로 서버에서 클라이언트로 가는 모든 메시지는 계속 배달될 수 있습니다. 그러나 클라이언트와 서버 간 이벤트 메시지는 동일한 지역의 업스트림 앱 서버로만 전송 됩니다.
5. 주 인스턴스가 복구 된 후 다시 온라인 상태가 되 면 app server에서 주 인스턴스가 정상으로 다시 검색 됩니다. 새로운 클라이언트가 기본에 다시 연결되므로 이제 협상은 기본 엔드포인트를 다시 반환합니다. 그러나 기존 클라이언트는 삭제 되지 않으며 연결을 끊을 때까지 보조 데이터베이스에 계속 연결 됩니다.

아래 다이어그램은 장애 조치 (failover)를 수행 하는 방법을 보여 줍니다.

그림 1. 장애 조치(failover) 전![장애 조치(failover) 전](media/concept-disaster-recovery/before-failover.png)

그림 2. 장애 조치(failover) 후![장애 조치(failover) 후](media/concept-disaster-recovery/after-failover.png)

그림 3. 기본 복구 후 잠시 동안 ![기본 복구 후 잠시 동안](media/concept-disaster-recovery/after-recover.png)

일반적인 경우에만 주 앱 서버 및 웹 PubSub 서비스에 온라인 트래픽 (파란색)이 있습니다.

장애 조치 (failover) 후에 보조 앱 서버 및 웹 PubSub 서비스도 활성화 됩니다.
기본 웹 PubSub 서비스가 다시 온라인 상태가 되 면 새 클라이언트는 기본 웹 PubSub에 연결 됩니다. 하지만 기존 클라이언트는 두 인스턴스 모두에 트래픽이 있으므로 계속 보조에 연결됩니다.

모든 기존 클라이언트 연결이 끊긴 후, 시스템은 정상으로 돌아갑니다(그림 1).

지역 간 고가용성 아키텍처를 구현하기 위한 두 가지 주요 패턴이 있습니다.

1. 첫 번째 방법은 모든 온라인 트래픽을 가져오는 앱 서버 및 웹 PubSub 서비스 인스턴스 쌍을 보유 하 고 다른 쌍을 백업 (활성/수동 이라고 함, 그림 1에 표시)로 만듭니다. 
2. 다른 하나는 하나 이상의 앱 서버와 웹 PubSub 서비스 인스턴스를 포함 하는 것입니다. 각 인스턴스는 온라인 트래픽의 일부를 사용 하 고 다른 쌍에 대 한 백업으로 사용 됩니다 (예는 그림 3과 유사 함).

웹 PubSub 서비스는 두 패턴을 모두 지원할 수 있습니다. 주요 차이점은 앱 서버를 구현 하는 방법입니다.
앱 서버가 활성/수동 인 경우 웹 PubSub 서비스도 활성/수동이 됩니다 (기본 앱 서버는 기본 웹 PubSub 서비스 인스턴스만 반환).
앱 서버가 활성/활성 상태인 경우에도 웹 PubSub 서비스는 활성/활성 상태입니다. 모든 앱 서버는 자체 기본 웹 PubSub 인스턴스를 반환 하므로 모든 사용자가 트래픽을 가져올 수 있습니다.

사용할 패턴에 관계 없이 각 웹 PubSub 서비스 인스턴스를 앱 서버에 **주** 역할로 연결 해야 합니다.

또한 WebSocket 연결의 특성 (긴 연결) 때문에 재해가 발생 하 고 장애 조치가 발생 하면 클라이언트에서 연결이 끊어집니다.
최종 고객에게 명료하도록 그러한 경우를 클라이언트 쪽에서 처리해야 합니다. 예를 들어 연결을 닫은 후 다시 연결을 수행합니다.

## <a name="next-steps"></a>다음 단계

이 문서에서는 웹 PubSub 서비스의 복원 력을 얻기 위해 응용 프로그램을 구성 하는 방법을 배웠습니다. 

[!INCLUDE [next step](includes/include-next-step.md)]